<!DOCTYPE html>
<html lang="en-US">
<head>

</head>
<body>
heoolo
<script type="text/javascript">
  const urlDomains = [
    "localhost",
    "learnearn.cn"
  ];
  const learnEarnAPIURL = [
    "http://localhost/answer/api/v1",
    "https://learnearn.cn/answer/api/v1"
  ];
  const MsgType = {
    LOGIN: 0,
    LOGOUT: 1
  }
  function getLoginStorage (key) {
    const value = localStorage.getItem(key);
    if (value) {
      try {
        return JSON.parse(value);
      } catch {
        return value;
      }
    }
    return undefined;
  }
  function getDataWithFetch(url, callback) {
    // 使用fetch发送GET请求
    fetch(url, {
      method: 'GET', // 指定请求方法为GET
      headers: {
        'Authorization': getLoginStorage(LOGGED_TOKEN_STORAGE_KEY),
        'Accept-Language': "zh_CN",
      },
    })
      .then(response => {
        if (response.ok) {
          // console.log(response.json());
          return response.json(); // 解析JSON响应数据
        } else {
          throw new Error('网络响应错误');
        }
      })
      .then(data => {
        console.log('服务器响应数据:', data);
        if(callback) {
          callback(data);
        }
      })
      .catch(error => {
        console.error('请求失败:', error);
      });
  }
  const logoutUrl = '/user/logout';
  const LOGGED_TOKEN_STORAGE_KEY = '_a_ltk_';
  function postDataWithFetch(url, data, callback) {
    // 使用fetch发送POST请求
    fetch(url, {
      method: 'POST', // 指定请求方法为POST
      headers: {
        'Content-Type': 'application/json' // 设置请求头，指定发送的数据格式为JSON
      },
      body: JSON.stringify(data) // 将JavaScript对象转换为JSON字符串
    })
      .then(response => {
        if (response.ok) {
          // console.log(response.json());
          return response.json(); // 解析JSON响应数据
        } else {
          throw new Error('网络响应错误');
        }
      })
      .then(data => {
        console.log('服务器响应数据:', data);
        // localStorage.setItem("user", JSON.stringify(data));
        callback(data);
      })
      .catch(error => {
        console.error('请求失败:', error);
      });
  }

  function getDomainName(url) {
    // 创建一个URL对象
    const parsedUrl = new URL(url);
    // 获取主机名，即域名部分
    const hostname = parsedUrl.hostname;
    return hostname;
  }
  window.addEventListener('message', function(event) {
    const currDomain = getDomainName(event.origin);
    console.log(currDomain, event.data);
    if (urlDomains.includes(currDomain)) {
      const msgType = event.data.type;
      // login
      if(!msgType) {
        const email = event.data.email;
        const password = event.data.password;
        // postDataWithFetch(assetBunAPIURL[urlDomains.indexOf(currDomain)] + "/user/session",
        //   { userName: email, Password: password },
        //   (data) => {
        //     localStorage.setItem("user", JSON.stringify(data));
        //   }
        // );
      } else if(msgType === MsgType.LOGOUT) {
        getDataWithFetch(learnEarnAPIURL[urlDomains.indexOf(currDomain)] + logoutUrl, (data) => {});
        localStorage.removeItem(LOGGED_TOKEN_STORAGE_KEY);
      }
    }
  }, false);
</script>
</body>
</html>
